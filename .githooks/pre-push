#!/bin/sh
set -e

# --- Color Definitions ---
# Adds color to the output for better readability.
RED='\033[0;31m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

# --- Dependency Sorting ---
echo "â€º Checking dependency sorting..."
if ! output=$(cargo sort --workspace --check 2>&1); then
    echo -e "${RED}âŒ Dependencies should be sorted.${NC}"
    echo -e "${RED}--- Failure Output ---${NC}\n$output\n${RED}----------------------${NC}"
    echo -e "${YELLOW}ğŸ’¡ To fix, run: 'cargo sort --workspace'${NC}"
    exit 1
fi

# --- Dependency Audit ---
echo "â€º Auditing dependencies..."
if ! output=$(cargo deny check 2>&1); then
    echo -e "${RED}âŒ Critical: Vulnerable dependencies detected.${NC}"
    echo -e "${RED}--- Failure Output ---${NC}\n$output\n${RED}----------------------${NC}"
    echo -e "${YELLOW}ğŸ’¡ To review, run: 'cargo deny check'${NC}"
    exit 2
fi

# --- Formatting Check ---
echo "â€º Checking code formatting..."
if ! output=$(cargo fmt --all -- --check 2>&1); then
    echo -e "${RED}âŒ Formatting issues found.${NC}"
    echo -e "${RED}--- Failure Output ---${NC}\n$output\n${RED}----------------------${NC}"
    echo -e "${YELLOW}ğŸ’¡ To fix, run: 'cargo fmt --all'${NC}"
    exit 3
fi

# --- Typo Check ---
echo "â€º Checking for typos..."
if ! output=$(typos 2>&1); then
    echo -e "${RED}âŒ Spelling mistakes found.${NC}"
    echo -e "${RED}--- Failure Output ---${NC}\n$output\n${RED}----------------------${NC}"
    echo -e "${YELLOW}ğŸ’¡ To fix, run: 'typos --write-changes'${NC}"
    exit 4
fi

# --- Linting (no default features) ---
echo "â€º Linting (no default features)..."
if ! output=$(cargo clippy --all-targets --no-default-features -- -D warnings 2>&1); then
    echo -e "${RED}âŒ Clippy (no default features) violations found.${NC}"
    echo -e "${RED}--- Failure Output ---${NC}\n$output\n${RED}----------------------${NC}"
    exit 5
fi

# --- Linting (all features) ---
echo "â€º Linting (all features)..."
if ! output=$(cargo clippy --all-targets --all-features -- -D warnings 2>&1); then
    echo -e "${RED}âŒ Clippy (all features) violations found.${NC}"
    echo -e "${RED}--- Failure Output ---${NC}\n$output\n${RED}----------------------${NC}"
    exit 5
fi

# --- Tests ---
echo "â€º Running tests..."
if ! output=$(cargo test --workspace --verbose 2>&1); then
    echo -e "${RED}âŒ Test failures detected.${NC}"
    echo -e "${RED}--- Failure Output ---${NC}\n$output\n${RED}----------------------${NC}"
    exit 6
fi

echo "âœ… All checks passed!"
